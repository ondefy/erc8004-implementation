{
  "description": "Comprehensive test cases for rebalancer validation circuit covering all edge cases, especially rebalancing to lower APY scenarios",
  "testCases": [
    {
      "name": "TC1: Normal case - Higher APY, all checks pass",
      "description": "Standard rebalancing to a better opportunity with higher APY",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC2: No old opportunity (oldApy = 0)",
      "description": "First deposit - no previous position, APY check should pass",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 0,
        "oldLiquidity": 0,
        "oldZyfiTvl": 0,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC3: Lower APY but shouldRebalanceFromOld (oldZyfiTVLCheck fails)",
      "description": "Rebalancing to lower APY because old pool TVL check fails",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 10000000,
        "oldZyfiTvl": 5000000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 0,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC4: Lower APY but shouldRebalanceFromOld (oldTvlStable fails)",
      "description": "Rebalancing to lower APY because old pool TVL is unstable",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 10000000,
        "oldZyfiTvl": 3000000,
        "oldTvlStable": 0,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC5: Lower APY but shouldRebalanceFromOld (oldLiquidityIsLow)",
      "description": "Rebalancing to lower APY because old pool liquidity is low (85% threshold)",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 5000000,
        "oldZyfiTvl": 4500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC6: Lower APY but shouldRebalanceFromOld (oldUtilizationStable fails)",
      "description": "Rebalancing to lower APY because old pool utilization is unstable",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 10000000,
        "oldZyfiTvl": 3000000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 0,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC7: Lower APY but shouldRebalanceFromOld (oldCollateralHealth fails)",
      "description": "Rebalancing to lower APY because old pool collateral health is poor",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 10000000,
        "oldZyfiTvl": 3000000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 0,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC8: Lower APY but supportsCurrentPool = 0",
      "description": "Rebalancing to lower APY because current pool is no longer supported",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 10000000,
        "oldZyfiTvl": 3000000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 0
      }
    },
    {
      "name": "TC9: Multiple old issues (shouldRebalanceFromOld with multiple failures)",
      "description": "Old pool has multiple issues: low liquidity + unstable TVL + poor collateral",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 5000000,
        "oldZyfiTvl": 4500000,
        "oldTvlStable": 0,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 0,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC10: Boundary - Available Liquidity exactly at threshold",
      "description": "liquidity * 85 = zyfiTvl * 100 (should fail - needs >)",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 1000000,
        "zyfiTvl": 850000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC11: Boundary - Available Liquidity just above threshold",
      "description": "liquidity * 85 > zyfiTvl * 100 (should pass)",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 1000001,
        "zyfiTvl": 850000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC12: Boundary - TVL exactly at threshold",
      "description": "poolTvl * 1000000 = amount * 400 (should fail - needs >)",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 125000000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC13: Boundary - TVL just above threshold",
      "description": "poolTvl * 1000000 > amount * 400 (should pass)",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 124999999,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC14: Boundary - APY exactly at threshold (0.1% improvement)",
      "description": "newApy = oldApy + 10 (should fail - needs >)",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50010,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC15: Boundary - APY just above threshold",
      "description": "newApy = oldApy + 11 (0.11% improvement, should pass)",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50011,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC16: APY Stability fails (apyStable7Days = 0)",
      "description": "New opportunity APY is not stable, should fail",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 0,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC17: TVL Stability fails (tvlStable = 0)",
      "description": "New opportunity TVL is not stable, should fail",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 1,
        "tvlStable": 0,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC18: Lower APY with shouldRebalanceFromOld - enoughLiquidity fails",
      "description": "Old pool doesn't have enough liquidity to withdraw, shouldRebalanceFromOld should be 0",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 100,
        "oldZyfiTvl": 3000000,
        "oldTvlStable": 0,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC19: Lower APY with shouldRebalanceFromOld - boundary liquidity check",
      "description": "Old liquidity just above threshold: oldLiquidity * 1e6 > amount * 100 (circuit uses > not >=)",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 101,
        "oldZyfiTvl": 3000000,
        "oldTvlStable": 0,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC20: Lower APY with shouldRebalanceFromOld - boundary oldLiquidityIsLow",
      "description": "Old liquidity just below 85% threshold: oldLiquidity * 85 < oldZyfiTvl * 100 (circuit uses < not <=)",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 999999,
        "oldZyfiTvl": 850000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC21: Lower APY with shouldRebalanceFromOld - oldLiquidityIsLow just above threshold",
      "description": "Old liquidity just above 85% threshold: oldLiquidity * 85 > oldZyfiTvl * 100",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 1000001,
        "oldZyfiTvl": 850000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC22: All edge cases combined - lower APY, multiple old issues, pool not supported",
      "description": "Complex scenario with multiple bypass conditions",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 55000,
        "oldLiquidity": 5000000,
        "oldZyfiTvl": 4500000,
        "oldTvlStable": 0,
        "oldUtilizationStable": 0,
        "oldCollateralHealth": 0,
        "oldZyfiTVLCheck": 0,
        "supportsCurrentPool": 0
      }
    },
    {
      "name": "TC23: Very high APY difference",
      "description": "Large APY improvement (5% -> 10%)",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 100000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC24: Very small APY difference (just above threshold)",
      "description": "Minimal APY improvement (5.0000% -> 5.0011%): newApy > oldApy + 10",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 50011,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC25: Maximum values (stress test)",
      "description": "Very large values to test overflow/underflow - liquidity must be > threshold",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 1000000001,
        "zyfiTvl": 850000000,
        "amount": 100000000,
        "poolTvl": 10000000000,
        "newApy": 200000,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 150000,
        "oldLiquidity": 900000000,
        "oldZyfiTvl": 800000000,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC26: Minimum values (stress test)",
      "description": "Very small values to test edge cases",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 118,
        "zyfiTvl": 100,
        "amount": 1,
        "poolTvl": 1,
        "newApy": 11,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 0,
        "oldLiquidity": 0,
        "oldZyfiTvl": 0,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC27: Zero new APY (edge case)",
      "description": "New opportunity has 0% APY but passes other checks",
      "expectedResult": "PASS",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 0,
        "apyStable7Days": 1,
        "tvlStable": 1,
        "oldApy": 0,
        "oldLiquidity": 0,
        "oldZyfiTvl": 0,
        "oldTvlStable": 1,
        "oldUtilizationStable": 1,
        "oldCollateralHealth": 1,
        "oldZyfiTVLCheck": 1,
        "supportsCurrentPool": 1
      }
    },
    {
      "name": "TC28: All boolean flags false (should fail)",
      "description": "All stability and health checks fail",
      "expectedResult": "FAIL",
      "input": {
        "liquidity": 10000000,
        "zyfiTvl": 2000000,
        "amount": 1000000,
        "poolTvl": 50000000,
        "newApy": 60000,
        "apyStable7Days": 0,
        "tvlStable": 0,
        "oldApy": 50000,
        "oldLiquidity": 8000000,
        "oldZyfiTvl": 1500000,
        "oldTvlStable": 0,
        "oldUtilizationStable": 0,
        "oldCollateralHealth": 0,
        "oldZyfiTVLCheck": 0,
        "supportsCurrentPool": 0
      }
    }
  ],
  "notes": {
    "scaling": {
      "liquidity": "Scaled by 100 (2 decimal precision)",
      "zyfiTvl": "Scaled by 100 (2 decimal precision)",
      "amount": "In token smallest units (no scaling)",
      "poolTvl": "Scaled by 100 (2 decimal precision)",
      "newApy": "Scaled by 10000 (4 decimal precision, e.g., 5.5234% = 55234)",
      "oldApy": "Scaled by 10000 (4 decimal precision)",
      "oldLiquidity": "Scaled by 100 (2 decimal precision)",
      "oldZyfiTvl": "Scaled by 100 (2 decimal precision)",
      "booleanFields": "0 or 1 (apyStable7Days, tvlStable, oldTvlStable, oldUtilizationStable, oldCollateralHealth, oldZyfiTVLCheck, supportsCurrentPool)"
    },
    "constraints": {
      "availableLiquidity": "liquidity * 85 > zyfiTvl * 100",
      "tvl": "poolTvl * 1000000 > amount * 400",
      "apyPerformance": "newApy > oldApy + 10 OR oldApy == 0 OR shouldRebalanceFromOld == 1 OR supportsCurrentPool == 0",
      "apyStability": "apyStable7Days == 1",
      "tvlStability": "tvlStable == 1"
    },
    "shouldRebalanceFromOld": {
      "condition": "enoughLiquidity && (oldZyfiTVLCheckFailed || oldTvlStableCheckFailed || oldLiquidityIsLow || oldUtilizationStableCheckFailed || oldCollateralHealthCheckFailed)",
      "enoughLiquidity": "oldLiquidity * 1000000 >= amount * 100",
      "oldLiquidityIsLow": "oldLiquidity * 85 < oldZyfiTvl * 100"
    }
  }
}
